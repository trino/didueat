<?php
    printfile("views/menus.blade.php");
    $alts = array(
            "product-pop-up" => "Product info",
            "up_cat" => "Move Category up",
            "down_cat" => "Move Category down",
            "up_parent" => "Move this up",
            "down_parent" => "Move this down",
            "deleteMenu" => "Delete this item",
            "edititem" => "Edit this item"
    );

    $menuTSv="?i=";
    $menuTS=read('menuTS');
    if($menuTS){
        $menuTSv="?i=".$menuTS;
        Session::forget('session_menuTS');
    }

    $prevCat="";
    $catNameStr=[];
    $parentCnt=[];
    $thisCatCnt=0;
    $itemPosnForJS=[];
    // $catCnt set in restaurants-menus.blade
?>

<script>
    var catPosn=[];
    var itemPosn=[];
    var restSlug="<?php echo e($restaurant->slug); ?>";
</script>

<?php if(!isset($_GET['page'])): ?>
    <div id="loadmenus_<?php echo e((isset($catid))?$catid:0); ?>">
<?php endif; ?>

<?php
    $menus_listA=[];
    $menus_sortA=[];
    $cats_listA=[];
    $cats_listA2=[];
    $thisCnt=0;

    foreach($menus_list as $value){
        $catsListCnt=0;
        foreach ($cats as $row) {
            if($row == $value->cat_id){
                $menus_listA[$thisCnt]=$value;
                $cats_listA[$row]=$catsOrder[$catsListCnt];
                $menus_sortA[$row][$thisCnt]=$value->display_order;
                $thisCnt++;
                break;
           }
           $catsListCnt++;
        }
    }

    asort($cats_listA);

    foreach ($cats_listA as $key => $row) {
        asort($menus_sortA[$key]);
        foreach ($menus_sortA[$key] as $key2 => $row2) {
            $cats_listA2[$key2]=$row;
        }
    }


    $valueA=[];
    $catIDNum=[];
    $cnt2=0;
    while(list($key,$thisOrder) = each($cats_listA2)){
        $valueA[$cnt2]=$menus_listA[$key]; // this contains full menus list for resto
        $catIDNum[$cnt2]=$menus_listA[$key]->cat_id;
        $cnt2++;
    }

?>

<?php while(list($index,$value) = each($valueA)): ?>

<?php
    $noUpCatSort=false;
    $thisUpMenuVisib="visible";
    $thisDownMenuVisib="visible";
    $parentCnt[$thisCatCnt]=$value->id; // for js sorting with ajax, not implemented yet
    $itemPosnForJS[$value->cat_id][$value->id]=$value->display_order;
    $catPosn[]=$thisCatCnt;
    if($prevCat == ""){
        $noUpCatSort=true;
    }

    if($index < ($thisCnt-1)){ // means it's not the last item
       $nextIndx=($index+1);
       if($value->cat_id != $catIDNum[$nextIndx]){
          $thisDownMenuVisib="hidden";
       }
    } else{
        $thisDownMenuVisib="hidden"; // last item in array
    }

    //echo "\$prevCat: ".$prevCat."  --  \$index: ".$index."  --  \$nextIndx: ".$nextIndx."  -- totalItems-1: ".($thisCnt-1)."  --  cat_id: ".$value->cat_id."  --   next CatID: ".$catIDNum[$nextIndx]."  --  ".$value->menu_item."  --  ".$value->display_order;

    if($value->cat_id != $prevCat){ // means it's a new category
        $thisUpMenuVisib="hidden";
        $catMenuCnt=0; // reset count for this category
        if($prevCat){
          echo '</div><!-- end of previous category --><hr width="100%" align="center" style="border-top:solid #000 2px" />';
        }
        $prevCat=$value->cat_id; // also used as current cat_id until next loop

        $catNameStr[$prevCat] = $value->cat_name;
        ($noUpCatSort)? $thisUpCatSort="hidden" : $thisUpCatSort="visible";
        ($thisCatCnt >= ($catCnt-1))? $thisDownCatSort="hidden" : $thisDownCatSort="visible";

?>

  <DIV class="list-group m-y-1" id="c<?php echo e($thisCatCnt); ?>" style="border: solid navy 4px"><!-- start of this category -->
    <div class="list-group-item parents"><!-- start of category heading -->
        <div class="">
            <div class="row">
                <div class="col-md-8"><a name="<?= $value->cat_name;?>"></a>
                    <h4 class="card-title"><?= $value->cat_name;?></h4>
                </div>

<!-- To sort Categories -->

                <div class="col-md-4">
                    <div class="btn-group pull-right" aria-label="Basic example" role="group">
                      <a title="<?php echo e($alts["up_cat"]); ?>" class="btn btn-sm btn-secondary" id="up<?php echo e($thisCatCnt); ?>" style="visibility:<?php echo e($thisUpCatSort); ?> !important" href="#" onclick="chngCatPosn(<?php echo e($thisCatCnt); ?>,'up');return false">
     <!-- <a title="<?php echo e($alts["up_cat"]); ?>" class="btn btn-sm btn-secondary" disabled="" href="<?= url("restaurant/orderCat2/".$value->cat_id."/up");?>"> -->
                            <i class="fa fa-arrow-up"></i>
                        </a>

                      <a title="<?php echo e($alts["down_cat"]); ?>" class="btn btn-sm btn-secondary" id="down<?php echo e($thisCatCnt); ?>" style="visibility:<?php echo e($thisDownCatSort); ?> !important" href="#" onclick="chngCatPosn(<?php echo e($thisCatCnt); ?>,'down');return false">
       <!-- <a title="<?php echo e($alts["down_cat"]); ?>" class="btn btn-sm btn-secondary" href="<?= url("restaurant/orderCat2/".$value->cat_id."/down");?>"> -->
                            <i class="fa fa-arrow-down"></i>
                        </a>
                    </div>
                </div>

<div class="col-md-6" id="save<?php echo e($thisCatCnt); ?>" style="display:none;color:#f00"><input name="saveOrderChng" type="button" value="Save All Category Order Changes" onclick="saveCatOrderChngs(<?php echo e($thisCatCnt); ?>)" /><span id="saveCatOrderMsg<?php echo e($thisCatCnt); ?>"></span></div>

<div class="col-md-6 pull-right" id="saveMenus<?php echo e($value->cat_id); ?>" style="display:none;color:#f00"><input name="saveOrderChng" type="button" value="Save Category Sorting" onclick="saveMenuOrder(<?php echo e($value->cat_id); ?>,false,false)" /><span id="saveMenuOrderMsg<?php echo e($value->cat_id); ?>"></span></div>

            </div>

        </div>
    </div><!-- end of category heading -->

<?php
    $thisCatCnt++;
}



//load images, duplicate code

                    $has_iconImage = false;

                    if ($value->image != '' && file_exists(public_path('assets/images/restaurants/' . $value->restaurant_id . '/menus/' . $value->id . '/icon-' . $value->image))) {
                        $item_iconImg = asset('assets/images/restaurants/' . $value->restaurant_id . '/menus/' . $value->id . '/icon-' . $value->image).$menuTSv;
                        $has_iconImage = true;
                    }

                    $has_bigImage = false;
                    if ($value->image != '' && file_exists(public_path('assets/images/restaurants/' . $value->restaurant_id . '/menus/' . $value->id . '/big-' . $value->image))) {
                        $item_bigImage = asset('assets/images/restaurants/' . $value->restaurant_id . '/menus/' . $value->id . '/big-' . $value->image).$menuTSv;
                        $has_bigImage = true;
                    }

                    $submenus = \App\Http\Models\Menus::where('parent', $value->id)->orderBy('display_order', 'ASC')->get();
                    $min_p = get_price($value->id);

                    $canedit = read("profiletype") == 1 || (read("profiletype") == 3 && $value->uploaded_by == read("id"));
                ?>

                <div class="list-group-item parents" id="parent<?php echo e($value->cat_id); ?>_<?php echo e($value->display_order); ?>"><!-- start of menu item -->
                    <div class="">
                        <div class="row">

                            <div class="col-md-12"><!-- start div 4 -->

                                <?php
                                    $main_price = $value->price;
                                    $dis = '';
                                    $everyday = '';
                                    $days = explode(',', $value->days_discount);
                                    $today = date('D');
                                    if ($value->has_discount == '1' && in_array($today, $days)) {
                                        if ($value->days_discount == 'Sun,Mon,Tue,Wed,Thu,Fri,Sat') {
                                            $everyday = 'everyday';
                                        } else {
                                            $everyday = str_replace($today, ',', $value->days_discount);
                                            $everyday = 'Today and ' . str_replace(',', '/', $everyday);
                                            $everyday = str_replace('//', '', $everyday);
                                            $everyday = str_replace(' and /','',$everyday);
                                        }
                                        $discount = $value->discount_per;
                                        $d = $main_price * $discount / 100;
                                        $main_price = $main_price - $d;
                                        $dis = "" . $discount . "% off " . $everyday . "";

                                    }
                                ?>

                                <h4 class="card-title">

                                <div class="" style="width: 100%;float:left;">

                                    <a href="#" id="<?php echo e($value->id); ?>"
                                       data-res-id="<?php echo e($value->restaurant_id); ?>"
                                       title="<?php echo e($alts["product-pop-up"]); ?>"
                                       class="card-link" data-toggle="modal"
                                       data-target="<?php echo e((Request::is('restaurants/*')) ? '#product-pop-up_' . $value->id : url('restaurants/' . select_field('restaurants', 'id', $value->restaurant_id, 'slug') . '/menu')); ?>">

                                        <?php if($has_iconImage): ?>
                                            <img src="<?php echo e($item_iconImg); ?>"
                                                 class="img-rounded" style="height:32px;width:32px;"
                                                 alt="<?php echo e($value->menu_item); ?>"/>
                                        <?php else: ?>
                                                    <!--i class="fa fa-arrow-right" style="font-size:20px;padding:0px;color:#fafafa;width:25px;height:25px;"></i-->
                                        <?php endif; ?>
                                        <?php if(debugmode()): ?> (<?php echo e($value->id); ?>) <?php endif; ?>
                                        <?php echo e($value->menu_item); ?>


                                        &ndash;
                                        <?php if($main_price>0): ?>
                                            $<?php echo e(number_format(($main_price>0)?$main_price:$min_p,2)); ?>

                                        <?php else: ?>
                                            $<?php echo e(number_format($min_p,2)); ?>+
                                        <?php endif; ?>
                                        <?php if($dis): ?>
                                            <strike class="text-muted btn btn-sm btn-link" style="float: right">$<?php echo e(number_format($value->price,2)); ?></strike>
                                        <?php endif; ?>
                                        <?php if($dis): ?>
                                            <strike class="text-muted btn btn-sm btn-link" style="float: right">$<?php echo e(number_format($value->price,2)); ?></strike>
                                        <?php endif; ?>

                                    </a>
                                   </div>

                                   <div class="" style=""></div>
                                </h4>




                                <div class="clearfix">
                                    <?php echo rating_initialize((session('session_id'))?"static-rating":"static-rating", "menu", $value->id); ?>

                                    <p class="card-text m-a-0">
                                        <?php echo e($dis); ?>

                                    </p>
                                </div>


                                <p class="card-text m-a-0  text-muted">
                                    <?php
                                        if (strlen($value->description) > 65) {
                                            echo substr($value->description, 0, 65) . '...';
                                        } else {
                                            echo substr($value->description, 0, 65);
                                        }
                                    ?>

                                </p>

                                <!--
                                <p class="card-text m-a-0 text-muted"> Category: <?php echo e($value->cat_name); ?>

                                <?php if($value->uploaded_on): ?>
                                    Submitted: <?php echo e($value->uploaded_on); ?>

                                <?php endif; ?>

                                <?php
                                    if($value->uploaded_by){
                                        $uploaded_by = \App\Http\Models\Profiles::where('id', $value->uploaded_by)->get()[0];
                                        echo "by: " . $uploaded_by->name . "";
                                    }
                                ?>
                                        </p>
                                -->


                                <?php if(false): ?> <!-- no tags yet -->
                                    <?php if(isset($restaurant->tags) && $restaurant->tags != ""): ?>
                                        <?php
                                            $tags = $restaurant->tags;
                                            $tags = explode(',', $tags);
                                            for ($i = 0; $i < 5; $i++) {
                                                if (isset($tags[$i])) {
                                                    echo "<span class='tags'>" . $tags[$i] . "</span>";
                                                }
                                            }
                                        ?>
                                    <?php endif; ?>
                                <?php endif; ?>


                            </div><!-- End div 4 -->


                            <div class="col-md-12"><!-- start div 5 0000-00-00 00:00:00 -->
                                <?php if(read('restaurant_id') == $restaurant->id || $canedit): ?>
                                    <div class="btn-group pull-left" role="group" style="vertical-align: middle">
                                        <span class="fa fa-spinner fa-spin" id="spinner<?php echo e($value->id); ?>" style="color:blue; display: none;"></span>
                                        <label class="c-input c-checkbox p-r-1" id="enable<?php echo e($value->id); ?>">
                                            <input <?php echo e(iif($value->is_active, "CHECKED")); ?> id="check<?php echo e($value->id); ?>" onclick="enableitem(<?php echo e($value->id); ?>);" type="checkbox" class="is_active">Enable Item
                                            <span class="c-indicator"></span>
                                        </label>

                                        <?php if($value->uploaded_by): ?>
                                            Uploaded by: <A HREF="<?php echo e(url("user/uploads/" . $value->uploaded_by)); ?>"><?php echo e(select_field("profiles", "id", $value->uploaded_by, "name" )); ?></A>
                                            <?php if($value->uploaded_on != "0000-00-00 00:00:00"): ?>
                                                on <?php echo e(date("M j 'y", strtotime($value->uploaded_on))); ?>

                                            <?php endif; ?>
                                        <?php endif; ?>
                                    </div>
                                    <div class="btn-group pull-right" role="group">
                                        <a id="up_parent_<?php echo e($value->id.'_'.$value->cat_id); ?>" title="<?php echo e($alts["up_parent"]); ?>"
                                           class="btn btn-sm btn-primary-outline sorting_parent"
                                           href="javascript:void(0);" onclick="menuItemSort(<?php echo e($value->id); ?>, <?php echo e($value->cat_id); ?>, <?php echo e($value->display_order); ?>, 'up', <?php echo e($catMenuCnt); ?>);return false" style="visibility:<?php echo e($thisUpMenuVisib); ?> !important">
                                           <i class="fa fa-arrow-up"></i></a>

                                        <a id="down_parent_<?php echo e($value->id.'_'.$value->cat_id); ?>" title="<?php echo e($alts["down_parent"]); ?>"
                                           class="btn btn-sm btn-primary-outline sorting_parent"
                                           href="javascript:void(0);" onclick="menuItemSort(<?php echo e($value->id); ?>, <?php echo e($value->cat_id); ?>, <?php echo e($value->display_order); ?>, 'down', <?php echo e($catMenuCnt); ?>);return false" style="visibility:<?php echo e($thisDownMenuVisib); ?> !important">
                                            <i class="fa fa-arrow-down"></i></a>

                                        <button id="add_item<?php echo e($value->id); ?>" type="button" title="<?php echo e($alts["edititem"]); ?>"
                                                class="btn btn-sm btn-primary-outline additem" data-toggle="modal"
                                                data-target="#addMenuModel"><strong>Edit</strong>
                                        </button>

                                        <a href="#"
                                           class="btn btn-sm btn-primary-outline"
                                           title="<?php echo e($alts["deleteMenu"]); ?>"
                                           onclick="deleteMenuItem(<?php echo $value->cat_id.', '.$value->id.', '.$value->display_order;?>);return false"><i class="fa fa-times"></i></a>
                                    </div>
                                <?php elseif(read("id") == $value->uploaded_by): ?>
                                    <button id="add_item<?php echo e($value->id); ?>" type="button" title="<?php echo e($alts["edititem"]); ?>"
                                            class="btn btn-sm btn-primary-outline additem pull-right" data-toggle="modal"
                                            data-target="#addMenuModel"><strong>Edit</strong>
                                    </button>
                                <?php endif; ?>


                            </div><!-- end div 5 -->
                        </div>
                    </div>

                    <div class="clearfix"></div>
                </div>
<?php
 $catMenuCnt++;
?>
                <?php echo $__env->make('popups.order_menu_item', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
            <?php endwhile; ?>

      </div> <!-- end of last category -->


<?php

$catIDforJS = array_keys($catNameStr);
$catIDforJS_Str = implode(",",$catIDforJS);
$catNameStrJS = implode("','",$catNameStr);

$objComma="";
$itemPosnForJSStr="";
foreach ($itemPosnForJS as $key => $row) { // $key is cat id
  $objStrJS="";
  foreach ($itemPosnForJS[$key] as $key2 => $row2) {
    $objComma=", ";
    if($objStrJS == ""){
    $objComma="";
    }
    $objStrJS.=$objComma.$key2.":".$row2;
  }
    $itemPosnForJSStr.="\n itemPosn[".$key."]={".$objStrJS."};"; // [catID]={menuID:displayOrder}
}


?>


<?php if(!isset($_GET['page'])): ?>
        </div>
    </div>
<?php endif; ?>

<div class="clearfix"></div>

<SCRIPT>

<?php echo $itemPosnForJSStr;?>

var itemPosnOrig=itemPosn;
var menuSortChngs=[];
var catOrigPosns=[<?php echo $catIDforJS_Str;?>]; // as original cat posns as indexes, with the values being the db cat_id
var currentCatOrderIDs=catOrigPosns;//Not sure if we'll need this - surrounding cat divs stay same on pg (indexes in array), but value chng to the cat_id
catNameA=['<?php echo $catNameStrJS;?>'];
catPosns=[]; // index is for surrounding cat divs, but the posn changes as user adjust order

catNameLnks="";
for(var i=0;i<catNameA.length;i++){
  var spaces="&nbsp; &nbsp; &nbsp;";
  if(i == 0){
    spaces="";
  }
  catPosns[i]=i;
  catNameLnks+=spaces+"<a HREF='#"+catNameA[i]+"'>"+catNameA[i]+"</a>";

  // menuSortChngs same indexing as catNameA (use for loop to get catid index, then use index on catNameA), prompt user to save if exiting pg
  menuSortChngs[catOrigPosns[i]]=false;
}
document.getElementById('categoryLinks').innerHTML="<b><u>View Menu Categories</u>:</b> &nbsp; &nbsp; "+catNameLnks;

    //enable/disable a menu item via ajax
    function enableitem(id){
        var checked = $("#check" + id).is(":checked");
        $("#enable" + id).hide();
        $("#spinner" + id).show();

        $.post("<?php echo e(url('restaurant/enable')); ?>", {
            value: checked,
            id: id,
            _token: "<?php echo e(csrf_token()); ?>"
        }, function (result) {
            if(!result){
                alert("Unable to enable/disable this item");
                $("#check" + id).prop('checked', false);
            }
            $("#enable" + id).show();
            $("#spinner" + id).hide();
        });
    }
</SCRIPT>