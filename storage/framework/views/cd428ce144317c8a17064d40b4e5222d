<?php
    if(!function_exists("toseconds")){
        printfile("dashboard/restaurant/restaurantpanel.blade.php");
        //convert a 24hr time into seconds
        function toseconds($Time){
            if(strpos($Time, ":") !== false){
                $Time = explode(":", $Time);
                return $Time[0] * 3600 + $Time[1] * 60 + $Time[2];
            }
            return $Time;
        }
        //get a rough estimate of the difference between 2 times
        function timediff($Start, $End = false){//end is the bigger time
            $Start = toseconds($Start);
            if(!$End){$End = time();}
            $End = toseconds($End);
            $Diff = abs($End - $Start);
            return durationtotext($Diff, false, ", ");
        }
    }

    if(is_object($Restaurant)){
        $Restaurant = getProtectedValue($Restaurant, "attributes");
    }

    $logo = defaultlogo($Restaurant);
    $Restaurant['tags'] = str_replace(",", ", ", $Restaurant['tags']);
    if ($Restaurant['is_delivery']) {
        $Delivery_enable = "Delivery";
    }
    if ($Restaurant['is_pickup']) {
        $Pickup_enable = "Pickup";
    }
    if(!isset($delivery_type)){
        $delivery_type = "is_pickup";
    }
    $key = iif($delivery_type == "is_delivery", "_del"); //check if store is open
    $is_open = \App\Http\Models\Restaurants::getbusinessday($Restaurant);


    $MoreTime = "";
    $grayout="";
    $Message = "Order Online";
    if(!$Restaurant['open']){
        $Message = "View Menu";
    }

    $user_time = date('H:i:s');

    $Day = current_day_of_week();
    if(!$is_open){
        $MoreTime="Currently closed";
        $grayout=" grayout";
        if($Restaurant['open']){
            for($day = 0; $day <7; $day++){
                $Day = current_day_of_week($day);
                $open = $Restaurant[$Day . "_open" . $key];
                $close = $Restaurant[$Day . "_close" . $key];
                if($open && $close && $open != $close){
                    $Date =  strtotime ($open, time() + ($day * 86400));
                    //$MoreTime = "Opens in " . timediff($Date);
                    $MoreTime = "Opens ";
                    if($day == 0){
                        $MoreTime  .= "today";
                    } else if ($day == 1){
                        $MoreTime  .= "tomorrow";
                    } else {
                        $MoreTime  .= "in " . $day . " days";
                    }
                    $MoreTime  .= " at " . converttime($open);
                    break;
                }
            }
        } else {
            $MoreTime = "Not accepting orders";
        }
    }
    $alts = array(
            "restaurants/menu" => "View Restaurant",
            "View Menu" => "View this restaurant's menu",
            "Order Online" => "Order from this restaurant's menu",
            "moredetails" => "View more information about this restaurant",
            "logo" => "This restaurant's logo"
    );
?>
<div class="list-group-item">
    <div class="col-md-3 col-xs-3 p-a-0" style="z-index: 1;">
        <div class="p-r-1" >
            <a href="<?php echo e(url('restaurants/' . $Restaurant['slug'] . '/menu')); ?>?delivery_type=<?php echo e($delivery_type); ?>" class="restaurant-url" title="<?php echo e($alts["restaurants/menu"]); ?>">
                <img style="max-width:100%;" class="img-rounded" alt="<?php echo e($alts["logo"]); ?>" src="<?php echo e($logo); ?>">
                <div class="clearfix"></div>
            </a>
        </div>
        <div class="clearfix"></div>
    </div>

    <div class="col-md-9 p-a-0">
        <a class="card-link restaurant-url" href="<?php echo e(url('restaurants/'.$Restaurant['slug'].'/menu')); ?>?delivery_type=<?php echo e($delivery_type); ?>" title="<?php echo e($alts["restaurants/menu"]); ?>">
            <h4 style="margin-bottom: 0 !important;">
                <?php echo e($Restaurant['name']); ?>

                <?php if(isset($order)): ?>
                    <div class="pull-right">
                        <a href="<?php echo e(url('restaurants/'.$Restaurant['slug'].'/menu')); ?>?delivery_type=<?php echo e($delivery_type); ?>" class="restaurant-url btn <?php if($Message=='View Menu'): ?> btn-secondary <?php else: ?> btn-primary <?php endif; ?> hidden-sm-down" title="<?php echo e($alts[$Message]); ?>"><?php echo e($Message); ?></a>
                    </div>
                <?php endif; ?>
            </h4>
        </a>

        <div>
            <?php if(!$is_open): ?>
                <div class="smallT"><?php echo e($MoreTime); ?></div>
            <?php endif; ?>
            <?php echo rating_initialize("static-rating", "restaurant", $Restaurant['id']); ?>


            <span class="list-inline-item"> <?php echo e(str_replace(",", ", ", $Restaurant["cuisine"])); ?></span>

            <div class="clearfix"></div>
        </div>


        <div><?php echo e($Restaurant['address']); ?>, <?php echo e($Restaurant['city']); ?></div>

        <?php if($Restaurant["is_delivery"]): ?>
            <?php if(!$Restaurant["is_pickup"]): ?>
                <span class="list-inline-item"><strong>Delivery only</strong></span>
            <?php endif; ?>
            <span class="list-inline-item">Delivery: <?php echo e(asmoney($Restaurant['delivery_fee'],$free=true)); ?></span>
            <span class="list-inline-item">Minimum: <?php echo e(asmoney($Restaurant['minimum'],$free=false)); ?></span>
        <?php elseif($Restaurant["is_pickup"]): ?>
            <span class="list-inline-item"><strong>Pickup only</strong></span>
        <?php endif; ?>

        <!--span class="label label-warning">Tags: <?php echo e($Restaurant['tags']); ?></span-->

        <?php if(isset($latitude) && $radius && $Restaurant['distance']): ?>
            <span class="list-inline-item">Distance: <?php echo e(round($Restaurant['distance'],2)); ?> km</span>
        <?php endif; ?>

        <?php if(isset($details) && $details): ?>
            <a class="list-inline-item" class="clearfix" href="#" data-toggle="modal" data-target="#viewMapModel" title="<?php echo e($alts["moredetails"]); ?>">More Details</a>
        <?php endif; ?>
    </div>
    <div class="clearfix"></div>
</div>

<?php
if(isset($is_menu) &&false){
    $menuitems = enum_all("menus", array("restaurant_id" => $Restaurant["id"], "is_active" => 1));
    if($menuitems){
        echo '<div class="list-group-item"><table class="table table-responsive m-b-0"><THEAD><TR><TH>Item</TH><TH>Cost</TH></TR></THEAD>';
        foreach($menuitems as $menuitem){
            //'restaurant_id', 'menu_item', 'description', 'price', 'rating', 'additional', 'has_addon', 'image', 'type', 'parent', 'req_opt', 'sing_mul', 'exact_upto', 'exact_upto_qty', 'display_order', 'cat_id', 'has_discount', 'discount_per', 'days_discount', 'is_active', 'uploaded_by', 'cat_name', 'uploaded_on'
            $filename = asset("assets/images/restaurants/" . $Restaurant["id"] . "/menus/" . $menuitem->id . "/icon-" . $menuitem->id . ".jpg");
            echo '<TR><TD><IMG SRC="' . $filename . '">' . $menuitem->menu_item . '</TD>';

            echo '<TD style="vertical-align: middle;">' . asmoney($menuitem->price) . '</TD></TR>';
        }
        echo '</TABLE><div class="clearfix"></div></DIV>';
    }
}
?>