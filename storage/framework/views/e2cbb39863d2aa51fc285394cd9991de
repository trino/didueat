<?php
    printfile("views/dashboard/user_reviews/ajax/list.blade.php");
    $alts = array(
            "edit" => "Edit this rating",
            "delete" => "Delete this rating"
    );
?>

<?php if(\Session::has('message')): ?>
<?php echo message_show("Message!", \Session::get('message')); ?>

<?php endif; ?>

<div class="card">

    <div class="card-header ">
        <div class="row">
            <div class="col-lg-9">
            <h4 class="card-title">Reviews</h4>
                </div>
            <?php echo $__env->make('common.table_controls', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
        </div>
    </div>

    <div class="card-block p-a-0">


        <table class="table table-responsive m-b-0">
            <?php if($recCount > 0): ?>
                <thead>
                    <tr>
                        <th width="10%">
                            <a class="sortOrder" data-meta="id" data-order="ASC" data-title="ID" title="Sort [ID] ASC"><i class="fa fa-caret-down"></i></a>
                            ID
                            <a class="sortOrder" data-meta="id" data-order="DESC" data-title="ID" title="Sort [ID] DESC"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th width="15%">
                            <a class="sortOrder" data-meta="user_id" data-order="ASC" data-title="User" title="Sort [User] ASC"><i class="fa fa-caret-down"></i></a>
                            User
                            <a class="sortOrder" data-meta="user_id" data-order="DESC" data-title="User" title="Sort [User] DESC"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th width="15%">
                            <a class="sortOrder" data-meta="target_id" data-order="ASC" data-title="Target" title="Sort [Target] ASC"><i class="fa fa-caret-down"></i></a>
                            Target
                            <a class="sortOrder" data-meta="target_id" data-order="DESC" data-title="Target" title="Sort [Target] DESC"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th width="10%">
                            <a class="sortOrder" data-meta="type" data-order="ASC" data-title="Type" title="Sort [Type] ASC"><i class="fa fa-caret-down"></i></a>
                            Type
                            <a class="sortOrder" data-meta="type" data-order="DESC" data-title="Type" title="Sort [Type] DESC"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th width="10%">
                            <a class="sortOrder" data-meta="rating" data-order="ASC" data-title="Rating" title="Sort [Rating] ASC"><i class="fa fa-caret-down"></i></a>
                            Rating
                            <a class="sortOrder" data-meta="rating" data-order="DESC" data-title="Rating" title="Sort [Rating] DESC"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th width="20%">
                            <a class="sortOrder" data-meta="comments" data-order="ASC" data-title="Comments" title="Sort [Comments] ASC"><i class="fa fa-caret-down"></i></a>
                            Comment
                            <a class="sortOrder" data-meta="comments" data-order="DESC" data-title="Comments" title="Sort [Comments] DESC"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th width="10%">
                            <a class="sortOrder" data-meta="created_at" data-order="ASC" data-title="Date" title="Sort [Date] ASC"><i class="fa fa-caret-down"></i></a>
                            Date
                            <a class="sortOrder" data-meta="created_at" data-order="DESC" data-title="Date" title="Sort [Date] DESC"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th width="10%">Action</th>
                    </tr>
                </thead>

                <tbody>
                    <?php foreach($Query as $key => $rating): ?>
                        <tr ID="rating<?php echo e($rating->id); ?>">
                            <td><?php echo e($rating->id); ?></td>
                            <td><?php echo e(select_field("profiles", "id", $rating->user_id, "name")); ?></td>
                            <td><?php echo e(($rating->type == "menu")?select_field("menus", "id", $rating->target_id, "menu_item"):select_field("restaurants", "id", $rating->target_id, "name")); ?></td>
                            <td><?php echo e($rating->type); ?></td>
                            <td><?php echo e($rating->rating); ?></td>
                            <td><?php echo e(substr($rating->comments, 0, 100)); ?></td>
                            <td><?php echo e($rating->created_at); ?></td>
                            <td>
                                <a class="btn btn-secondary-outline btn-sm editRow" data-toggle="modal" data-target="#editModel"  data-id="<?php echo e($rating->id); ?>" title="<?php echo e($alts["edit"]); ?>">Edit</a>
                                <!--a href="<?php echo e(url('user/reviews/action/'.$rating->id)); ?>" class="btn btn-secondary-outline btn-sm" onclick="return confirm('Are you sure to delete review  <?php echo e(addslashes("'" . $rating->rating . "'")); ?> ?');"><i class="fa fa-times"></i></a-->
                                <a class="btn btn-secondary-outline btn-sm" onclick="deleterating('<?php echo e($rating->id); ?>', '<?php echo e(addslashes("'" . $rating->comments . "'")); ?>');" title="<?php echo e($alts["delete"]); ?>">
                                    <i ID="delete<?php echo e($rating->id); ?>" class="fa fa-times"></i>
                                </a>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            <?php else: ?>
                <tbody>
                    <tr>
                        <td><span class="text-muted">No Reviews</span></td>
                    </tr>
                </tbody>
            <?php endif; ?>
        </table>
    </div>

    <?php if(Session::get('session_type_user') == "super"  && $recCount > 10): ?>
        <div class="card-footer clearfix"><?php echo $Pagination; ?></div>
    <?php endif; ?>
</div>
<SCRIPT>
    var Ratings = '<?php echo e($recCount); ?>';
    function deleterating(ID, Name){
        if(confirm('Are you sure you want to delete rating "' + Name + '"?')) {
            $("#delete" + ID).attr('class', "fa fa-spinner fa-spin");
            $.post("<?php echo e(url('user/reviews/action')); ?>/" + ID, {_token: "<?php echo e(csrf_token()); ?>"}, function (result) {
                Ratings=Ratings-1;
                if(Ratings) {
                    $("#rating" + ID).fadeOut();
                } else {
                    location.reload();//ajax isn't working here for some reason :/
                }
            });
        }
    }
</SCRIPT>